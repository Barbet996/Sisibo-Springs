<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Allocation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-teal-100 min-h-screen font-inter">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Stock Allocation</h1>
                <p class="text-gray-600 mt-2">Control stock access for managers and staff</p>
            </div>
            <a href="index.html" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                Back to Home
            </a>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-6">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span id="successText">Stock allocated successfully!</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Allocation Form -->
            <div class="bg-gradient-to-br from-emerald-200 via-cyan-50 to-teal-200 rounded-xl shadow-lg p-8 border border-gray-100">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">Allocate Stock</h2>
                
                <form id="allocationForm" class="space-y-6">
                    <div>
                        <label for="itemSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Item</label>
                        <select id="itemSelect" name="itemSelect" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                            <option value="">Choose an item...</option>
                        </select>
                    </div>

                    <div id="itemDetails" class="hidden bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Total Stock:</span>
                                <span id="totalStock" class="font-medium text-gray-800"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">Available for Allocation:</span>
                                <span id="availableStock" class="font-medium text-emerald-600"></span>
                            </div>
                        </div>
                        <div class="mt-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Manager Allocated:</span>
                                <span id="managerAllocated" class="font-medium text-blue-600"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Staff Allocated:</span>
                                <span id="staffAllocated" class="font-medium text-purple-600"></span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="userRole" class="block text-sm font-medium text-gray-700 mb-2">Allocate To</label>
                        <select id="userRole" name="userRole" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                            <option value="">Select role...</option>
                            <option value="manager">Manager</option>
                            <option value="staff">Staff</option>
                        </select>
                    </div>

                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">Quantity to Allocate</label>
                        <input type="number" id="quantity" name="quantity" min="0" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                        <p class="text-xs text-gray-500 mt-1">Set to 0 to remove allocation</p>
                    </div>

                    <div id="allocationSummary" class="hidden bg-emerald-50 p-4 rounded-lg border border-emerald-200">
                        <h3 class="font-medium text-gray-800 mb-2">Allocation Summary</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Item:</span>
                                <span id="summaryItem" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Role:</span>
                                <span id="summaryRole" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Current Allocation:</span>
                                <span id="summaryCurrentAllocation" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>New Allocation:</span>
                                <span id="summaryNewAllocation" class="font-medium text-emerald-600"></span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-emerald-600 text-white py-3 px-6 rounded-lg hover:bg-emerald-700 transition-colors font-medium">
                        Update Allocation
                    </button>
                </form>
            </div>

            <!-- Current Allocations -->
            <div class="space-y-6">
                <!-- Stock Overview -->
                <div class="bg-gradient-to-br from-teal-200 via-cyan-50 to-emerald-200 rounded-xl shadow-lg p-6 border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Stock Overview</h3>
                    <div id="stockOverview" class="space-y-3">
                        <!-- Stock overview will be populated here -->
                    </div>
                </div>

                <!-- Current Allocations -->
                <div class="bg-gradient-to-br from-emerald-200 via-cyan-50 to-teal-200 rounded-xl shadow-lg p-6 border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Current Allocations</h3>
                    <div id="currentAllocations" class="space-y-3">
                        <!-- Current allocations will be populated here -->
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-gradient-to-br from-teal-200 via-cyan-50 to-emerald-200 rounded-xl shadow-lg p-6 border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <button id="clearAllAllocations" class="block w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 transition-colors text-center">
                            Clear All Allocations
                        </button>
                        <a href="stock.html" class="block w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors text-center">
                            View Stock Summary
                        </a>
                        <a href="add.html" class="block w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors text-center">
                            Add New Items
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication - only admin can access
            if (!AuthManager.checkRole('admin')) {
                return; // Will redirect automatically
            }
            
            loadItems();
            loadStockOverview();
            loadCurrentAllocations();
            
            // Handle item selection
            document.getElementById('itemSelect').addEventListener('change', function() {
                const selectedItem = inventoryData.getItem(this.value);
                if (selectedItem) {
                    showItemDetails(selectedItem);
                } else {
                    hideItemDetails();
                }
            });

            // Handle role and quantity changes
            document.getElementById('userRole').addEventListener('change', updateAllocationSummary);
            document.getElementById('quantity').addEventListener('input', updateAllocationSummary);

            // Handle form submission
            document.getElementById('allocationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                processAllocation();
            });

            // Handle clear all allocations
            document.getElementById('clearAllAllocations').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all stock allocations? This will remove access for all managers and staff.')) {
                    inventoryData.stockAllocations = {};
                    inventoryData.saveStockAllocations();
                    showSuccessMessage('All stock allocations have been cleared.');
                    loadItems();
                    loadStockOverview();
                    loadCurrentAllocations();
                    hideItemDetails();
                }
            });
        });

        function loadItems() {
            const itemSelect = document.getElementById('itemSelect');
            const items = inventoryData.items;
            
            itemSelect.innerHTML = '<option value="">Choose an item...</option>';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (${item.quantity} total)`;
                itemSelect.appendChild(option);
            });
        }

        function loadStockOverview() {
            const stockOverview = document.getElementById('stockOverview');
            const items = inventoryData.items;
            
            if (items.length === 0) {
                stockOverview.innerHTML = '<p class="text-gray-500 text-sm">No items in inventory.</p>';
                return;
            }

            stockOverview.innerHTML = items.map(item => {
                const totalAllocated = inventoryData.getTotalAllocatedStock(item.id);
                const availableForAllocation = inventoryData.getAvailableForAllocation(item.id);
                const managerAllocated = inventoryData.getAllocatedStock(item.id, 'manager');
                const staffAllocated = inventoryData.getAllocatedStock(item.id, 'staff');
                
                return `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-gray-800">${item.name}</p>
                                <p class="text-sm text-gray-600">Total: ${item.quantity} | Available: ${availableForAllocation}</p>
                            </div>
                            <div class="text-right text-sm">
                                ${managerAllocated > 0 ? `<p class="text-blue-600">Manager: ${managerAllocated}</p>` : ''}
                                ${staffAllocated > 0 ? `<p class="text-purple-600">Staff: ${staffAllocated}</p>` : ''}
                                ${totalAllocated === 0 ? '<p class="text-gray-500">No allocations</p>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadCurrentAllocations() {
            const currentAllocations = document.getElementById('currentAllocations');
            const allocations = inventoryData.stockAllocations;
            
            if (Object.keys(allocations).length === 0) {
                currentAllocations.innerHTML = '<p class="text-gray-500 text-sm">No stock allocations set.</p>';
                return;
            }

            const allocationsByRole = {};
            Object.keys(allocations).forEach(key => {
                const [itemId, role] = key.split('_');
                const item = inventoryData.getItem(itemId);
                if (item) {
                    if (!allocationsByRole[role]) {
                        allocationsByRole[role] = [];
                    }
                    allocationsByRole[role].push({
                        item: item,
                        quantity: allocations[key]
                    });
                }
            });

            let html = '';
            Object.keys(allocationsByRole).forEach(role => {
                const roleColor = role === 'manager' ? 'blue' : 'purple';
                html += `
                    <div class="mb-4">
                        <h4 class="font-medium text-${roleColor}-600 mb-2 capitalize">${role} Allocations</h4>
                        <div class="space-y-2">
                            ${allocationsByRole[role].map(allocation => `
                                <div class="flex justify-between items-center p-2 bg-${roleColor}-50 rounded">
                                    <span class="text-sm">${allocation.item.name}</span>
                                    <span class="text-sm font-medium text-${roleColor}-600">${allocation.quantity}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            currentAllocations.innerHTML = html;
        }

        function showItemDetails(item) {
            document.getElementById('itemDetails').classList.remove('hidden');
            document.getElementById('totalStock').textContent = item.quantity;
            document.getElementById('availableStock').textContent = inventoryData.getAvailableForAllocation(item.id);
            document.getElementById('managerAllocated').textContent = inventoryData.getAllocatedStock(item.id, 'manager');
            document.getElementById('staffAllocated').textContent = inventoryData.getAllocatedStock(item.id, 'staff');
            
            const availableForAllocation = inventoryData.getAvailableForAllocation(item.id);
            document.getElementById('quantity').max = availableForAllocation + inventoryData.getAllocatedStock(item.id, document.getElementById('userRole').value || 'manager');
            
            updateAllocationSummary();
        }

        function hideItemDetails() {
            document.getElementById('itemDetails').classList.add('hidden');
            document.getElementById('allocationSummary').classList.add('hidden');
        }

        function updateAllocationSummary() {
            const itemId = document.getElementById('itemSelect').value;
            const userRole = document.getElementById('userRole').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            
            if (!itemId || !userRole) {
                document.getElementById('allocationSummary').classList.add('hidden');
                return;
            }

            const item = inventoryData.getItem(itemId);
            if (!item) return;

            const currentAllocation = inventoryData.getAllocatedStock(itemId, userRole);
            
            document.getElementById('summaryItem').textContent = item.name;
            document.getElementById('summaryRole').textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
            document.getElementById('summaryCurrentAllocation').textContent = currentAllocation;
            document.getElementById('summaryNewAllocation').textContent = quantity;
            
            document.getElementById('allocationSummary').classList.remove('hidden');
        }

        function processAllocation() {
            const formData = new FormData(document.getElementById('allocationForm'));
            const itemId = formData.get('itemSelect');
            const userRole = formData.get('userRole');
            const quantity = parseInt(formData.get('quantity'));

            const item = inventoryData.getItem(itemId);
            if (!item) {
                alert('Please select a valid item.');
                return;
            }

            const result = inventoryData.allocateStock(itemId, userRole, quantity);
            
            if (result !== null) {
                const action = quantity === 0 ? 'removed' : 'updated';
                showSuccessMessage(`Stock allocation ${action} successfully! ${userRole.charAt(0).toUpperCase() + userRole.slice(1)} now has ${result} units of ${item.name}.`);
                
                // Reset form
                document.getElementById('allocationForm').reset();
                hideItemDetails();
                loadItems();
                loadStockOverview();
                loadCurrentAllocations();
            } else {
                const availableForAllocation = inventoryData.getAvailableForAllocation(itemId);
                const currentAllocation = inventoryData.getAllocatedStock(itemId, userRole);
                const maxAllocation = availableForAllocation + currentAllocation;
                alert(`Cannot allocate ${quantity} units. Maximum available for allocation: ${maxAllocation}`);
            }
        }

        function showSuccessMessage(message) {
            const successMessage = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            
            successText.textContent = message;
            successMessage.classList.remove('hidden');
            
            // Hide success message after 5 seconds
            setTimeout(() => {
                successMessage.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>